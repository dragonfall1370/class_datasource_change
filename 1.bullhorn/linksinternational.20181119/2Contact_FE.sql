select * from bullhorn1.bh_userskill where userid in (162199)
select * from bullhorn1.bh_skilllist where skillid in (1000219,1000220,1000459)
select * from BULLHORN1.BH_CategorySkillAssociation where categoryID in (107408)
select * from  bullhorn1.BH_CategoryList where name like '%investment%%'


select top 100 UC.userid743177
       , *      
from bullhorn1.BH_Client Cl
left join bullhorn1.BH_UserContact UC ON Cl.userID = UC.userid
--where desiredCategories is not null and desiredCategories <> ''
where Cl.userid in (162199)


-- CATEGORY
with
--cat0(userid, desiredCategories) as (SELECT userid, Split.a.value('.','varchar(2000)') AS desiredCategories FROM (SELECT userid, CAST('<M>' + REPLACE(cast(desiredCategories as varchar(max)),';','</M><M>') + '</M>' AS XML) AS x from bullhorn1.BH_Client where desiredCategories is not null and desiredCategories <> '') t CROSS APPLY x.nodes('/M') as Split(a) )
cat1 (clientID, desiredCategories) as (SELECT m.clientID, desiredCategories.value as desiredCategories FROM bullhorn1.BH_Client m CROSS APPLY STRING_SPLIT(m.desiredCategories,';') AS desiredCategories where (isdeleted <> 1 and status <> 'Archive') and (desiredCategories is not null and desiredCategories <> '') )
--select distinct desiredCategories from cat1 where desiredCategories not in ('A2','Accounting','Actuarial','Administration','Advertising','Airline','Banking and Finance','Capital Goods','Casino','Consumer Goods','Corporate Commercial','Corporate Social Responsibility','Customer Service','Design','Distribution/Distributor','Ecommerce','Education','Engineering','Exhibitions','Finance and Accountancy','Footwear','Fresh Graduate','Garments','General Management','Health, Beauty and Spa','Healthcare','Hospitality','Human Resources','Industrial','Insurance','IT','Legal','Legal/Compliance','Logistics and Supply Chain Management','Manufacturing','Marketing','Mass Market Brands','Media','Nutritionist/Dietician','Other Area(s)','Property','Property and Construction','Public Relations','Recruitment','Relocation','Retail','Sales','Temp & Contract','Textiles','zLanguage Skills');
--select concat('insert into functional_expertise(id,name) values (nextval(''functional_experties_id_seq''),''',a.desiredCategories,''');') from (select distinct desiredCategories from cat1) a

--select distinct(desiredCategories), count(*) from cat1 group by desiredCategories;
--select count(*) from cat1 --123926
select * from cat1 where clientID in (161981,162199)



-- CATEGORY
with
  CateSplit(userid, categoryid) as (SELECT userid, Split.a.value('.','varchar(2000)') AS categoryID FROM (SELECT userid, CAST('<M>' + REPLACE(cast(concat(categoryid,',',categoryIDList) as varchar(max)),',','</M><M>') + '</M>' AS XML) AS x FROM  bullhorn1.BH_UserContact) t CROSS APPLY x.nodes('/M') as Split(a) )
--select * from CateSplit where userid in (161981,162199)
, CName(Userid, Name) as (SELECT Userid, ltrim(rtrim(CL.occupation)) as occupation from CateSplit left join bullhorn1.BH_CategoryList CL ON CateSplit.categoryid = CL.categoryID where CateSplit.categoryid <> '')
--select distinct CName.Name from CName where Name not in ('.Net','585','586','623','A-Share','A2','A32','Accessories','Account Coordinator','Account Director','Account Director - Media','Account Executive','Account Executive - Media','Account Manager','Account Manager - Media','Accountant','Accounting','Accounting & Finance','Accounting Manager','Accounts Payable','Accounts Receivable','Acquisition Finance','Actuarial','Actuarial - Modelling','Actuarial - Pricing','Actuarial - Valuations','Actuary','Admin Assistant','Administration','Administrative Assistant','Advertiser','Advertising','Ae','Airline','Alcohol/Tobacco','AML','Analyst','Analyst Programmer','Anti Bribery and Corruption','Apparel','Application','Architect','Architect (AE / SOA)','Architecture','Artificial Flowers','Asset Allocation','Asset Management','Asset/ Property Management','Assistant Relationship Manager','Assistant Shop Manager','Assistant Supervisor','Audit','Audit Accountant','Automotive','Automotive / Automotive Parts','B2B','B2C','Back Office Settlements','Bags/Handbags','Banking & Finance','Banking and Finance','Bookkeeper','Books','Booth Promoter','Brand Management','Brand Manager','Brand Manager/Director','Brand/Product Manager','Broker / Dealer / Sales Trader','Broker/Dealer','Building Maintenance','Business Analyst','Business Analyst (Front Office Trading)','Business Analyst (non-IT)','Business Development','Business Development Executive/Director','Business Development Manager/Director','Business Development Manager/Director/Executive','Business Director','Business Management (Non-IT)','Business Manager (IT)','Business Planning','Business Process Management','Business Process Reengineering','Business Risk and Control','Business Support','Buyer','Buying','Call Center Manager','Call Centre Manager','Capital Goods','Capital Markets','Capital Markets - Debt / Equity','Capital Markets - Debt/Equity','Cash Management','Casino','Category Management','Category Manager','CDD (customer due diligence)','CEO (Chief Executive Officer)','CFO','CFO (Chief Financial Officer)','CFO/Finance Director','Change Management','Channel Marketing','Channel Sales','Channel Sales Manager','Chemical','Chemical / Material','Chief Financial Officer','Chief Investment Officer','CIO (Chie Investment Officer)','CIO (Chief Information Officer)/Head of IT','Civil Engineer','Civil Engineering','Claims','Clerk','Client Analyst','Client On-Boarding','Client Onboarding','Client Services Manager','Client Servicing','Clinical Research','Clothing and Fashion','Collateral Management','Collateral Management Advisor','Communications','Communications Specialist','Company Secretarial duties','Company Secretary','Compensation and Benefits','Compensation and Benefits Manager','Compliance','Compliance Legal','Compliance Officer','Compliance Research','Construction','Consultant','Consumer Goods','Control Room Compliance','Conveyancing','COO/Chief Operating Officer','Coporate finance','Copywriter','Corporate','Corporate Action','Corporate Banking','Corporate Commercial','Corporate Communication','Corporate Communications','Corporate Crime & Investigations','Corporate Finance','Corporate Finance/Investment Banking','Corporate Sales','Corporate Sales Executive','Corporate Sales Manager','Corporate Social Responsibility','Corporate Social Responsibility (CSR)','Corprate commercial','Cosmetics','Cost Accountant','Courier Services','Creative Director','Credit -Manager/Controller/Officer','Credit Analyst','Credit Card - Sales/Marketing','Credit Control','Credit Manager/Controller/Officer','Credit Risk','Credit Risk Management','CRM','CRM Executive/Manager/Director','CSR / Public Affairs','Customer Service','Customer Service Representative','Data Analyst / Modeler','Data Analyst/Business Analyst','Data Entry Clerk','Database Administer','Database Administrator','Database Architect','DCM','Delivery Manager','Denim','Derivatives','Derivatives - Credit','Derivatives - Equity','Derivatives - Interest','Design','Desktop Publishing','Developer','Developer (J2EE','Developer (Oracle','Digital Marketing','Digital Media','Direct Marketing','Direct Sales','Distribution','Distribution Manager/Director','Distribution/Distributor','DO NOT USE - old Banking and Finance code','DO NOT USE - old FMCG code','DO NOT USE - old Luxury Goods code','DO NOT USE - old Retail code','Document Control - Real Estate','Documentation','Driver','Duty Free','E-commerce','ECM','Ecommerce','Economist','Economist/Strategist','Editor','Education','Electrical Engineer','Electronic Engineer','Electronic Engineering','Electronics','Employment','Engineering','English - basic/willing to speak (6 of of 10)','English - poor (below 5 out of 10)','Enterprise Risk Management','Equipment Administrator','Equities','Equities Settlement','Estate Agent/Sales & Leasing','Estate Management','ETF','Event Coordination/Planning','Event Marketing','Event Organizer','Event Planning','Events','Execution','Executive Assistant','Executive Management','Executive Search','Exhibition Coordinator','Exhibition Helper','Exhibitions','Expat Relocation','Facilities / Admin Officer','Facilities Management','Facilities Manager','FAE','Family office','FATCA','FATCA (foreign account tax compliance act)','Finance','Finance and Accountancy','Finance Change','Finance Director/VP Finance/Head of Finance','Finance Manager','Finance Operations','Financial Accountant','Financial Analyst','Financial Consultant','Financial Controller','Financial Modelling','Financial Planner','Financial Products','Financial Risk Management','Financial System Analyst','Fixed Assets Accountant','Fixed Income','Fixed Income Settlement','Flight Attendant','Floor/Department Store Manager','FMCG','Footwear','Foreign Exchange','Foreign Exchange Trading Asian Currencies','Foreign Exchange Trading Other Currencies','Forensic Accountant','FP&A','Franchise Manager','Freight','Freight Forwarding','Fresh Graduate','Front Desk','Frontline Sales','Fund Accountant','Fund Administration','Fund Management','Fund Manager','Fund Operations','Fund Raiser','Fund Settlement','Fundraiser','Fundraising','Furniture','Futures / Options','Futures/Options','FX Sales','Garments','General Counsel','General Management','General Manager','General Marketing','Global Custodian','Global Mobility','Global Support Center Specialist (HD)','Government','Government/Regulatory affairs','Graphic Artist','Graphic Design - Mkt','Graphic Design - Real Estate','Graphic Designer','Group Account Director','H-Share','Hand Bags','Hard Goods','Hardware design','Head of compliance','Head of Compliance/CCO','Head of HR/CHRO','Head of IT/CIO','Head of Marketing','Head of Operations','Head of Risk/CRO','Head of Sales','Health Beauty and Spa','Health Safety and Environment (HSE)','Health, Beauty and Spa','Healthcare','Hedge Funds','Home Decor','Hospital Administration','Hospitality','Hospitality - Catering','Hospitality - Food and Beverage','Hospitality - General Sports','Hospitality - Golf','Hotel Operations','Household Goods','HR','HR (Specialist Domain)','HR Analyst / Coordinator','HR Assistant','HR Business Partner','HR Compensation and Benefits','HR comps and bens','HR Director','HR Employee Relations','HR Generalist','HR Immigration','HR Immigration Services','HR Learning & Development','HR Manager','HR Recruiter','HR Specialist','HR Training and Development','HR, GA & Facilities','HRIS','HSSE','Human Resource(sample only)','Human Resources','I.T. Administration','IBD Compliance','IC Analog Design','IC Digital Design','Immigration Specialist','Import','In-house Legal Counsel','Industrial','Industrial Engineer','Industrial Equipment / Plant / Parts','Information/Data Vendors','Inside Sales','Institutional Sales','Institutional Sales / Mutual Funds','Institutional Sales/Mutual Funds','Insurance','Intellectual Property','Interior Design','Interior Design - Commerical Buildings','Interior Design - Offices','Interior Designer','International Assignment Manager/Specialist','Investment','Investment Accountant','Investment Analyst','Investment Consulting','Investment Director','Investment Funds & Asset Management','Investment Manager','Investment Writer','Investor Relations','IPO Accounting','IPO dealings','IT','IT & Telecoms','IT - Application Support','IT Audit','IT Consultant','IT Manager','IT Risk Analyst','IT Sales / Business Development','IT Sales Support','IT Sales/Business Development','IT Support','IT Trainer','Journalist','Junior Accountant','Key Account Management','Key Account Manager/Executive','Knit','Knowledge Management','KYC','KYC/AML','Labor Law Administrator','Ladieswear','Landscaping','Lawyer/Solicitor','Layout Design','Lean/Continuous Improvement','Leasing','Leather goods','Legal','Legal Assistant','Legal Counsel','Legal Document Analyst','Legal Secretary','Legal Secretary - Float','Legal Secretary - Night','Legal/Compliance','Leverage Finance','Librarian','Listed Company','Litigation','Logistics','Logistics & Supply Chain','Logistics - Function','Logistics and Supply Chain Management','Logistics/Supply Chain Management','Luxury Goods','M&A','Magazines/Newspapers','Maintenance','Management Accountant','Management Reporting','Managing Director','Managing Director/GM/Ops Manager','Manufacturing','Manufacturing Engineer','Market Analyst','Market Research','Market Risk','Market Risk Management','Marketing','Marketing Analytics and Intelligence','Marketing and Communication','Marketing Communication','Marketing Communications','Marketing Coordinator','Marketing Manager','Marketing Manager/Director/Executive','Markets Compliance','Markteting','Mass Market Brands','Material Planning','Mechanical Engineer','Mechanical Engineering','Media','Media Planning/Booking','Media Production','Medical Device / Diagnostics / Analytical','Medical Products','Menswear','MEP (Mechanical, Elect, Plumbing)','Merchandiser','Merchandising','Middle Office','MIS Reporting','MPF / Pension Plan','MPF/Pension Plan','Music','Mutual Funds','Network Engineer','Network Support','NIGHT Secretary','Nonwoven','Not for Profit Organizations','Nutritionist/Dietician','Ocean Freight','Office Assistant','Office Equipment','Office Leasing','Office Manager','Oil and Gas','On-line Marketing','Online Marketing Director','Online Marketing Executive','Online Marketing Manager','Operational Risk','Operational Risk Management','Operations','Operations Analyst','Operations Change (BA to PM)','Operations Manager','Origination','Other','Other Area(s)','Others','Paralegal','Payroll','Performance Analytics','Personal Assistant','Pharmaceutical / CRO / Reagents / Personal Care','Pharmaceuticals','Physical Design','Plant/Operations Manager','PMO Analyst (IT)','Portfolio Manager/Fund Manager','PR Executive','PR Manager/Director','Pricing/ Valuations','Pricing/Valuations','Prime Brokerage','Private Banking','Private Equity','Private Equity/ Venture Capital','Procurement & Sourcing','Product Control','Product Development','Product Development Manager/Executive/Director','Product Management','Product Manager/Brand Manager','Product Marketing/Management','Product Specialist','Production Engineer','Production Manager','Program Director (IT)','Program Manager (IT)','Programmer','Project Accountant','Project Coordinator (IT)','Project Engineer','Project Finance','Project Management','Project Manager','Project Manager (Front Office Trading)','Project Manager (IT)','Project/Program Management','Property','Property Analysis','Property and Construction','Property Developer','Property Development','Property Manager','Public Relations','Publishing','Purchasing','QA Manager / Lead','QA Tester','Quality Assurance/Quality Control','Quality Management','Quant Analyst','Quant Risk Management (Risk Modeller)','Quantity Surveyor','Raw Materials','Real Estate','Real Estate & Insurance','Receptionist','Recruitment','Recruitment Coordinator','Recruitment Manager','Regional HR','Regional HR Director','Regulation and Trade','Regulatory Accounting','Regulatory Compliance','Relationship Management','Relationship Manager','Relocation','Relocation Operations Manager','Research','Research Analyst','Research and Development (R&D)','Research/Investment Analysis','Researcher','Residential Leasing','Retail','Retail Banking','Retail Leasing','Retail Marketing','Retail Operations','Retail Operations Manager/Executive','Retail Sales','Retail Sales Manager/Executive','Retail Training','Retail/Intermediary Sales','RFP','Risk','Risk Analyst / Manager (Default Category if needed)','Risk Change','Risk Management','Risk Reporting','Sales','Sales & Marketing','Sales / Business Development','Sales Analyst','Sales and Trading','Sales Manager','Sales Manager/Director','Sales Rep/Account Executive','Sales Support/Assistant','Sales Trader','Seasonal Items','Secretarial','Secretary','Secretary/Executive Assistant','Securities','Semi-Conductor','Semiconductor / Embedded Device','Senior Account Director','Senior Account Executive','Senior Account Manager','Service - Manufacturing','Service Delivery','Service Sales','Settlements','Shipping','Shipping Clerk','Shipping Finance','Shipping Manager','Shop Manager','Site Management','Social Media','Social Media Marketing','SOFTWARE DESIGN','Software Engineer','Spa Manager/Director','Spare Parts','Sports','Sportswear','Storage Administrator','Store Allcoations','Store Planning','Store Project Management','Strategic Alliances','Strategic Planner','Strategy','Structured Finance','Structuring','Summer Students','Supervise Staff','Supply Chain Analyst','Supply Chain Coordinator','Supply Chain Management','Supply Chain Manager','Supply Chain Officer','Surveying','Sustainability','Syndictation','System Analyst','System Engineer','Systems Accountant','Systems Administrator','Systems Engineer','Tax','Tax Accountant','Tax Corporate','Tax Global Mobility','Tax Individual','Tea Lady','Teacher','Technical Writer','Technology','Telemarketer','Temp & Contract','test','Test Cat 1-RN','Testing','testing123','Textiles','Toys and Gifts','Trade Finance','Trade Marketing','Trade Marketing Manager','Trade Support','Trade Surveillance/Monitoring','Trader','Trader - Derivatives','Trader - Equity','Trader - Fixed Income','Trading (Financial Services)','Trading Company/Buying Office','Trafficing','Training','Transaction Banking','Transfer Agency','Translation','Translator','Transportation','Treasury','Treasury Accountant','Trust Accountant','Trust Administrator','Trust Officer','Trust Services','Trusts & Estates','Underwear/Intimates','Underwriter','Underwriting','Unit Trusts','Validation Design','Valuations','Verification Design','Vice President Marketing','Vice President Sales','Visual Merchandiser','Visual Merchandising','VP Finance','Warehousing','Watches / Jewelry','Watches and Jewellry','Watches and Jewelry','Wealth Management','Web Developer','Web Development Manager','Wholesale Manager','Wholesales','Wines / Spirits','Woven','z_lsc','zLanguage Skills')
--select * from bullhorn1.BH_CategoryList where categoryid in (107424,45)
select
         Cl.clientID as 'contact-externalId' , Cl.userID as '#UserID'
       , UC.firstName, UC.middleName, UC.lastName
       , UC.categoryid, UC.categoryidlist
       , CName.Name
-- select distinct CName.Name --UC.categoryidlist --UC.categoryid
from bullhorn1.BH_Client Cl 
left join bullhorn1.BH_UserContact UC ON Cl.userID = UC.userid
left join CName on CName.userid = Cl.userid
where CName.Name is not null
where Cl.userid in (161981,162199)
where UC.categoryid is not null or UC.categoryidlist is not null

with -- SkillName: split by separate rows by comma, then combine them into SkillName
  SkillName0(userid, skillID) as (SELECT userid, Split.a.value('.', 'VARCHAR(2000)') AS skillID FROM (SELECT userid, CAST('<M>' + REPLACE(cast(skillIDList as varchar(max)),',','</M><M>') + '</M>' AS XML) AS x FROM  bullhorn1.Candidate where isdeleted <> 1 and status <> 'Archive') t CROSS APPLY x.nodes('/M') AS Split(a) )
, SkillName(userId, SkillName) as (SELECT userId, SL.name from SkillName0 left join bullhorn1.BH_SkillList SL ON SkillName0.skillID = SL.skillID WHERE SkillName0.skillID <> '')
select * from SkillName where userid in (162199)









-- VERSION 2
-- CATEGORY
with
  CATEGORY(clientID, userid, name) as (
       select C.clientID, C.userid, UC.name
       from bullhorn1.BH_Client C
       --left join bullhorn1.BH_UserContact UC ON Cl.userID = UC.userid
       left join ( select UC.userID, UC.categoryID, replace(replace(replace(replace(replace(name,'4294:',''),'4295:',''),'4296:',''),'4297:',''),'850:','') as name from BULLHORN1.View_UserCategory UC left join bullhorn1.BH_CategoryList CL ON UC.categoryid = CL.categoryID ) UC on UC.userid = C.userID
       where C.isdeleted <> 1 and C.status <> 'Archive' --and C.userid in (162199)
       )
 
 
/*-- SPECIALTY
, SPECIALTY(clientID, userid, name) as (
       select C.clientID, C.userid, UC.name
       FROM bullhorn1.BH_Client C
       left join ( select US.userID, US.SpecialtyID, VS.name as name from BULLHORN1.View_UserSpecialty US left join bullhorn1.View_Specialty VS ON US.SpecialtyID = VS.specialtyID ) UC on UC.userid = C.userID
       where C.isdeleted <> 1 and C.status <> 'Archive' --and C.userid in (162199)
       )
*/

--, fe0 as (select distinct replace(replace(replace(replace(name,'4294:',''),'4295:',''),'4296:',''),'4297:','') as name from CATEGORY UNION select distinct replace(replace(replace(replace(name,'4294:',''),'4295:',''),'4296:',''),'4297:','') from SPECIALTY)
--select * from fe0 where name not in ('.Net')
--select count(*) from fe0
--select concat('insert into functional_expertise(id,name) values (nextval(''functional_experties_id_seq''),''',name,''');') from SpeName0 where Name not in (select distinct Name from CName) 
--select concat('insert into functional_expertise(id,name) values (nextval(''functional_experties_id_seq''),''',name,''');') from fe0 where name is not null and name <> '' order by Name asc

, fe as (select * from CATEGORY /*UNION select * from SPECIALTY*/ )

select --top 10 
       C.clientID, fe.userid, fe.name
--select count(*) 
FROM  bullhorn1.BH_Client C
left join fe on fe.userid = C.userid
where isdeleted <> 1 and status <> 'Archive' and fe.name is not null
and C.userid in (162199)
--select fe.name, count(*) FROM  bullhorn1.Candidate C left join fe on fe.userid = C.userid where isdeleted <> 1 and status <> 'Archive' group by fe.name
